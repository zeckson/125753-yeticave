# Техническое задание на личный проект «Интернет-аукцион» для базового PHP-интенсива

# Общая концепция

Интернет-аукцион «YetiCave» – это простой сервис, позволяющий пользователям продать свои личные вещи по максимально выгодной для них цене - на основе аукциона.

Пользователь, предложивший максимальную цену получает вещь по этой стоимости.

## Основные сценарии использования сайта:

- Публикация лота
- Добавление ставок
- Поиск лотов по категориям и названиям
- Определение победителя на основе максимальной ставки

# Техническое описание

Для разработки сайта предлагается уже готовая верстка, от программиста требуется лишь написать так называемый бэкенд сайта, т.е. сделать сайт динамическим, реализовать возможности по добавлению, просмотру лотов и приему ставок.

Разработка бэкенда должна вестись на языке программирования PHP 7 и выше, база данных – MySQL 5.7 и выше.
Не предполагается использование языка JavaScript для клиентского программирования.

При разработке схемы базы данных необходимо принимать во внимание какие сущности необходимо хранить, их поля и возможные связи друг с другом.

# Описание процессов

Процесс – это автономная операция, выполняющая полезное действие. К примеру: добавление нового комментария или регистрация аккаунта.

## Регистрация нового акканта

Выполняется после заполнения формы на странице «Регистрация аккаунта».
Последовательность действий:

1. Проверить, что отправлена форма
2. Убедиться, что заполнены все обязательные поля
3. Проверить, что указанный email уже не используется другим пользователем
4. Если есть ошибки заполнения формы, то сохранить их в отдельном массиве
5. Если ошибок нет, то сохранить данные формы в таблице пользователей
6. Если был выбран файл аватара, то сохранить его в отдельной публичной папке и добавить ссылку на аватар в таблицу пользователей

Если были допущены ошибки (не заполнены все поля, email занят и т.д.), то не сохранять данные, а показать ошибки в форме под соотвествующими полями.

Если данные были сохранены успешно, то переадресовать пользователя на страницу входа, где показать сообщение над формой «Теперь вы можете войти, используя свой email и пароль».

**Примечания**

Необходимо проверять, что значение из поля &quot;email&quot; действительно является валидным E-mail адресом. Для этих целей использовать встроенную функцию **filter\_var** и фильтр **FILTER\_VALIDATE\_EMAIL**

Для хранения пароля в БД его предварительно нужно обработать встроенной функцией **password**** \_ ****hash**

Также проверять формат загруженного файла в поле «Аватар», это обязательно должно быть изображение.
Для проверки сравнивать MIME-тип файла со списком разрешенных. Чтобы определить MIME-тим файла использовать функцию **mime**** \_ ****content**** \_ ****type**

## Публикация нового лота

Страница доступна только аутентифицированным пользователям.

Выполняется после заполнения формы на странице «Добавление лота». Все поля формы обязательны к заполнению.
Последовательность действий:

1. Проверить, что отправлена форма
2. Убедиться, что заполнены все поля
3. Выполнить все проверки
4. Если есть ошибки заполнения формы, то сохранить их в отдельном массиве
5. Если ошибок нет, то сохранить новый лот в таблице лотов, а файл изображения перенести в публичную директорию и сохранить ссылку

При успешном сохранении формы переадресовывать пользователя на страницу просмотра лота.

Список проверок

**Проверка изображения**
Обязательно проверять MIME-тип загруженного файла.
Допустимые форматы файлов: jpg, jpeg, png.
Для проверки сравнивать MIME-тип файла со значением «image/png», «image/jpeg» Чтобы определить MIME-тим файла использовать функцию **mime**** \_ ****content**** \_ ****type**

**Проверка начальной цены**
Содержимое поля «начальная цена» должно быть числом больше нуля.

**Проверка даты завершения**
Содержимое поля «дата завершения» должно быть датой в формате «ДД.ММ.ГГГГ». Проверять, что указанная дата больше текущей даты хотя бы на один день.

**Проверка шага ставки**
Содержимое поля «шаг ставки» должно быть целым числом больше ноля.

## Авторизация на сайте

Выполняется после заполнения формы на странице «Авторизация на сайте».
Последовательность действий:

1. Проверить, что отправлена форма
2. Убедиться, что заполнены все обязательные поля
3. Если есть ошибки заполнения формы, то сохранить их в отдельном массиве
4. Найти в БД пользователя с переданным email
5. Проверить, что переданный в форме пароль совпадает с сохраненным
6. Если пользователь найден и пароли совпадают, то открыть новую сессию, в которую записать идентификатор пользователя

После успешной авторизации пользователь попадает на главную страницу.

**Примечания**

Для проверки пароля использовать встроенную функцию **password**** \_ ****verify**

## Добавление ставки

Выполняется после заполнения формы на странице просмотра лота.
Последовательность действий:

1. Проверить, что пользователь залогинен
2. Убедиться, что заполнено поле «ваша сумма»
3. Выполнить проверку значения поля «ваша сумма»
4. Добавить ставку в таблицу ставок с привязкой к лоту

**Проверка ставки**
Значение поля «ваша сумма» должно отвечать следующим требованиям:

- целое положительное число
- значение должно быть больше, чем текущая цена лота + минимальный шаг

После сохранения комментария выполнить переадресацию на страницу просмотра лота, чтобы избежать повторного добавления при обновлении страницы.

## Определение победителя

Главная задача сервиса – это определять победившую ставку по истечению времени размещения лота.
Код для этого процесса можно разместить в отдельном сценарии и подключить к показу главной страницы, таким образом он будет выполняться при каждом посещении пользователем главной страницы.

Алгоритм работы:

1. Найти все лоты без победителей, дата истечения которых меньше или равна текущей дате
2. Для каждого такого лота найти последную ставку
3. Записать в лот победителем автора последней ставки
4. Отправить победителю на email письмо – поздравление с победой

## Поиск

Выполняется после отправки формы поиска с любой страницы.

Последовательность действий:

1. Проверить, что была отправлена форма
2. Получить текст из поля поиска и убрать пробелы функцией **trim**
3. Проверить, что получившаяся строка не пустая
4. Выполнить поиск в таблице лотов по полям «имя» и «описание», используя SQL оператор «LIKE»
5. Показать результаты поиска на соответствующей странице

**Примечания**

Искать следует как по описанию и названию.

Если найденных лотов больше девяти, то делить поисковую выдачу на страницы и показывать постраничную навигацию.

# Список всех экранов

Сайт состоит из следующих экранов:

- Главная страница
- Регистрация аккаунта
- Авторизация на сайте
- Лоты по категории
- Результаты поиска
- Добавление нового лота
- Просмотр лота
- Список моих ставок

## Регистрация аккаунта

Чтобы пользователь имел возможность добавить на сайт свой лот, ему необходимо пройти процедуру регистрации на этой странице.

Форма состоит из пяти обязательных полей и кнопки «регистрация». Форма отправляется методом «POST».

**Описание полей:**

| Лейбл | Тип поля | Обязательность |
| --- | --- | --- |
| Email | Простое текстовое поле | **Да** |
| Пароль | Поле типа &quot;password&quot; | **Да** |
| Имя | Простое текстовое поле | **Да** |
| Контактные данные | Поле типа «textarea» | **Да** |
| Аватар | Поле типа &quot;file&quot; | **Нет** |

Пользователю надлежит заполнить все обязательные поля, указав свой действительный email, пароль для входа на сайт, имя, под которым будут публиковаться его лоты, контактные данные и, при желании, файл аватара.

После заполнения формы, пользователь нажимает кнопку «_Регистрация_» для отправки данных формы на сервер.
Сама процедура регистрации описана в отдельном разделе – «_Регистрация нового пользователя_».

Если по итогам выполнения процесса регистрации возникли ошибки заполнения формы, то эти ошибки должны быть показаны красным текстом под необходимыми полями, а над самой формой появится сообщение «_Пожалуйста, исправьте ошибки в форме_».

## Авторизация на сайте

Форма состоит из двух полей:

- Email
Тип: текстовое поле
- Пароль
Тип: поле типа «password»

Под ними элемент типа «checkbox» с лейблом «_Запомнить меня_» и кнопка «_Войти_», отправляющая форму.
Все поля, кроме галочки «_запомнить меня_» обязательны к заполнению.

Процедура авторизации описана в отдельном разделе – «Авторизация пользователя».

Если по итогам выполнения процесса авторизаци возникли ошибки заполнения формы, то эти ошибки должны быть показаны красным текстом под необходимыми полями, а над самой формой появится сообщение «_Пожалуйста, исправьте ошибки в форме_».

Если пользователь ввел неверные данные аккаунта (несуществующий пользователь или неверный пароль), то в сообщении над формой должен быть текст «_Вы ввели неверный_ _email__/пароль_».

## Лоты по категории

Страница состоит из заголовка с текстом: «_Все лоты в категории_ %имя\_категории%»,
где %имя\_категории% - это название выбранной категории.

Под заголовком находится список из девяти лотов, принадлежащих к выбранной категории. Лоты отсортированы по дате публикации, от новых к старым.
Если в категории больше лотов, то внизу страницы появляется блок постраничной навигации.

## Результаты поиска

Страница состоит из заголовка с текстом: «_Результаты поиска по запросу_ %поисковый\_запрос%», где %поисковый\_запрос % - это текст, который ввел пользователь в строку поиска.

Данный текст должен быть предварительно обработан функцией htmlspecialchars.
Под заголовком находится список из девяти лотов, найденных по поисковому запросу. Лоты отсортированы по дате публикации, от новых к старым.
Если в категории больше девяти лотов, то внизу страницы появляется блок постраничной навигации.

## Добавление нового лота

Авторизованный пользователь может опубликовать на сайте свой лот.

Под заголовком располагается форма из семи обязательных полей и кнопки «Опубликовать».

| Лейбл | Тип поля | Обязательность |
| --- | --- | --- |
| Наименование | Простое текстовое поле | **Да** |
| Описание | Поле типа &quot;textarea&quot; | **Да** |
| Изображение | Поле типа &quot;file&quot; | **Да** |
| Категория | Выпадающий список | **Да** |
| Начальная цена | Простое текстовое поле | **Да** |
| Дата завершения | Простое текстовое поле | **Да** |
| Шаг ставки | Простое текстовое поле | **Да** |

Выпадающий список поля «Категория» содержит все доступные на сайте категории. Пользователь обязательно должен выбрать одну из них.

Поле «дата завершения» должно быть снабжено выпадающим календарем для удобного выбора даты.

После заполнения формы, пользователь нажимает кнопку «_Опубликовать_» для отправки данных формы на сервер.
Сама процедура добавления описана в отдельном разделе – «_Публикация нового лота_».

Если по итогам выполнения процесса отправки возникли ошибки заполнения формы, то эти ошибки должны быть показаны красным текстом под необходимыми полями, а над самой формой появится сообщение «_Пожалуйста, исправьте ошибки в форме_».

## Просмотр лота

Основные функции этой страницы:

- Просмотр информации лота
- Добавление своей ставки
- Просмотр контактной информации продавца

Страница делится вертикально на две части в пропорции 2/1: основной контент и блок для показа информации торгов.

**Основной контент**

Начинается с заголовка из названия просматриваемого лота.
Под заголовком, на всю ширину блока располагается изображение – фото товара.

Под фотографией блок с информацией:

- наименование
- описание
- название категории

Далее находится блок для добавления ставки, который начинается с заголовка «Добавить ставку».
За заголовком следует текстовое поле с лейблом «Ваша сумма» и кнопкой «Разместить ставку». Под полем подпись с указанием минимально возможной ставки.

**Ограничения**

Блок добавления ставки **не показывается** если:

- пользователь не авторизован
- срок размещения лота истёк

**Информация торгов**

Это вертикальная колонка, в которой друг под другом расположены блоки «Торги» и «История торгов».

**Блок «Торги»**

Показывает текущую стоимость лота – самая последняя ставка, либо изначальная цена.
Помимо стоимости есть информация о дате истечения лота, а также общее количество ставок на лот.

**Блок «История торгов»**

Показывает историю размещения ставок: от самых новых к самым старым. Информация о каждой ставке в этом блоке состоит из имени пользователя, суммы и времени размещения ставки в человеческом формате (5 минут назад, час назад и т.д.).

## Мои ставки

Страница, где пользователь видит все свои ставки на различные лоты.
Каждая ставка имеет следующую информацию:

- название лота (ссылка на страницу)
- сумма ставки
- дата/время

Выигравшие ставки должны выделяться отдельным цветом, а также там должны быть размещены контакты владельца лота.

# Основные сущности

Список всех сущностей

- Категория
- Лот
- Ставка
- Пользователь

## Категория

Состоит только из названия. Каждый лот должен быть привязан к одной категории.
Список доступных на сайте категорий: транспорт, электроника, хобби, для дома, животные, одежда, красота и здоровье.

## Лот

Центральная сущность всего сайта.
Поля:

- **дата создания** – дата и время, когда этот лот был создан пользователем
- **название** – задается пользователем
- **описание** – задается пользователем
- **изображение** – ссылка на файл изображения
- **начальная цена**
- **дата завершения**
- **шаг ставки**
- **количество добавлений в избранное**

Связи:

- **автор** – пользователь, создавший лот
- **победитель –** пользователь, выигравший лот
- **категория –** категория объявления

## Ставка

Ставка – это зафиксированное намерение пользователя приобрести товар, указанный в лоте по фиксированной стоимости. Пользователь может добавлять несколько ставок для одного лота, чтобы «перебить» ставки конкурентов.

Поля:

- **дата** – дата и время размещения ставки
- **сумма** – цена, по которой пользователь готов приобрести лот

Связи:

- **пользователь**
- **лот**

## Пользователь

Представляет зарегистрированного пользователя.

Поля:

- **дата регистрации** – дата и время, когда этот пользователь завел аккаунт
- **email**
- **имя**
- **пароль** – хэшированный пароль пользователя
- **аватар** – ссылка на загруженный аватар пользователя
- **контакты** – контактная информация для связи с пользователем

Связи:

- **созданные лоты**
- **ставки**

# Роли пользователей

Посетители сайта поделены на две группы: анонимные пользователи и зарегистрированные.

Анонимные пользователи имеют доступ только к просмотру лотов, поиску, навигации по категориям.
Пользователи, прошедшие регистрацию, дополнительно получают возможность публиковать свои лоты и делать ставки.